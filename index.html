<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AI íšŒì˜ë¡ ìš”ì•½ - Final Version</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
    <style>
        @keyframes pulse { 0% { box-shadow: 0 0 0 0 rgba(239, 68, 68, 0.7); } 70% { box-shadow: 0 0 0 15px rgba(239, 68, 68, 0); } 100% { box-shadow: 0 0 0 0 rgba(239, 68, 68, 0); } }
        .recording { animation: pulse 1.5s infinite; }
        .saved-indicator { transition: opacity 1s; }
        .loader { border: 4px solid #f3f3f3; border-radius: 50%; border-top: 4px solid #3498db; width: 24px; height: 24px; animation: spin 2s linear infinite; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
        .history-item:hover { background-color: #f3f4f6; }
    </style>
</head>
<body class="bg-gray-100 flex items-center justify-center min-h-screen p-4">

    <div class="bg-white rounded-2xl shadow-lg p-6 md:p-8 w-full max-w-4xl">
        <header class="text-center mb-6">
            <h1 class="text-3xl font-bold text-blue-600">ğŸ™ï¸ AI íšŒì˜ë¡ ìš”ì•½</h1>
            <p class="text-gray-500 mt-2">íšŒì˜ ë…¹ìŒ ë˜ëŠ” íŒŒì¼ ì—…ë¡œë“œ í›„ AIë¡œ ìš”ì•½í•˜ê³  ê³µìœ í•˜ì„¸ìš”.</p>
        </header>

        <div class="space-y-4 mb-6 bg-blue-50 p-4 rounded-lg">
            <div>
                <label for="openai_key" class="block text-sm font-medium text-gray-700">OpenAI API Key (Whisper ìš©)</label>
                <div class="relative mt-1">
                    <input type="password" id="openai_key" class="block w-full px-3 py-2 bg-white border border-gray-300 rounded-md shadow-sm" placeholder="sk-...">
                    <span id="openai_saved" class="saved-indicator absolute right-3 top-2 text-xs text-green-500 opacity-0">Saved!</span>
                </div>
            </div>
            <div>
                <label for="google_key" class="block text-sm font-medium text-gray-700">Google AI API Key (Gemini ìš©)</label>
                <div class="relative mt-1">
                    <input type="password" id="google_key" class="block w-full px-3 py-2 bg-white border border-gray-300 rounded-md shadow-sm" placeholder="AIza...">
                    <span id="google_saved" class="saved-indicator absolute right-3 top-2 text-xs text-green-500 opacity-0">Saved!</span>
                </div>
            </div>
        </div>

        <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
            <div class="text-center p-4 border rounded-lg">
                <h2 class="font-semibold mb-4">ğŸ”´ ì‹¤ì‹œê°„ ë…¹ìŒ</h2>
                <button id="recordBtn" class="w-24 h-24 rounded-full bg-red-500 text-white flex flex-col items-center justify-center mx-auto transition-colors duration-300 hover:bg-red-600">
                    <span>ë…¹ìŒ</span>
                    <span id="timer" class="text-xs mt-1">00:00</span>
                </button>
            </div>
            <div class="text-center p-4 border rounded-lg flex flex-col justify-center">
                <h2 class="font-semibold mb-4">ğŸ“ íŒŒì¼ ì—…ë¡œë“œ</h2>
                <input type="file" id="fileUploader" class="block w-full text-sm text-gray-500 file:mr-4 file:py-2 file:px-4 file:rounded-full file:border-0 file:text-sm file:font-semibold file:bg-blue-50 file:text-blue-700 hover:file:bg-blue-100" accept="audio/*,video/*">
            </div>
        </div>

        <details class="mt-4 bg-gray-50 p-4 rounded-lg">
            <summary class="cursor-pointer font-semibold text-gray-700">âš™ï¸ ê³ ê¸‰ ì„¤ì •</summary>
            <div class="mt-4 space-y-3">
                <div>
                    <label for="summaryStyle" class="block text-sm font-medium text-gray-700">ìš”ì•½ ìŠ¤íƒ€ì¼</label>
                    <select id="summaryStyle" class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md">
                        <option value="default">ê¸°ë³¸ (í•µì‹¬ìš”ì•½ + ìƒì„¸ë‚´ìš© + Action Items)</option>
                        <option value="brief">ê°„ëµ (í•µì‹¬ë§Œ)</option>
                        <option value="detailed">ìƒì„¸ (ëª¨ë“  ë‚´ìš© í¬í•¨)</option>
                        <option value="minutes">íšŒì˜ë¡ í˜•ì‹</option>
                    </select>
                </div>
                <div>
                    <label for="customPrompt" class="block text-sm font-medium text-gray-700">ì»¤ìŠ¤í…€ í”„ë¡¬í”„íŠ¸ (ì„ íƒì‚¬í•­)</label>
                    <textarea id="customPrompt" rows="3" class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md" placeholder="ì˜ˆ: ê¸°ìˆ ì ì¸ ë‚´ìš© ìœ„ì£¼ë¡œ ìš”ì•½í•´ì£¼ì„¸ìš”..."></textarea>
                </div>
            </div>
        </details>

        <div id="status" class="mt-6 text-center font-semibold text-gray-600 min-h-[24px] flex items-center justify-center gap-2"></div>

        <div id="result-container" class="mt-4 hidden">
            <h3 class="text-xl font-bold">âœ¨ ìš”ì•½ ê²°ê³¼</h3>
            <div id="result" class="whitespace-pre-wrap bg-gray-50 p-4 rounded-lg border max-h-96 overflow-y-auto"></div>
            <div class="mt-4 flex flex-wrap justify-center gap-3">
                <button id="copyBtn" class="bg-gray-500 text-white px-4 py-2 rounded-lg hover:bg-gray-600">ğŸ“‹ ë³µì‚¬</button>
                <button id="shareBtn" class="bg-blue-500 text-white px-4 py-2 rounded-lg hover:bg-blue-600">ğŸ”— ê³µìœ </button>
                <button id="pdfBtn" class="bg-green-600 text-white px-4 py-2 rounded-lg hover:bg-green-700">ğŸ“„ PDF</button>
                <button id="saveToHistory" class="bg-purple-500 text-white px-4 py-2 rounded-lg hover:bg-purple-600">ğŸ’¾ íˆìŠ¤í† ë¦¬ ì €ì¥</button>
            </div>
        </div>

        <details id="historySection" class="mt-6 bg-gray-50 p-4 rounded-lg">
            <summary class="cursor-pointer font-semibold text-gray-700">ğŸ“š ìµœê·¼ ìš”ì•½ íˆìŠ¤í† ë¦¬</summary>
            <div id="historyList" class="mt-4 space-y-2 max-h-60 overflow-y-auto"></div>
            <button id="clearHistory" class="mt-2 text-xs text-red-500 hover:text-red-700">íˆìŠ¤í† ë¦¬ ëª¨ë‘ ì‚­ì œ</button>
        </details>
    </div>

    <script>
        // ========== ì „ì—­ ë³€ìˆ˜ ==========
        const elements = {
            openaiKey: document.getElementById('openai_key'), googleKey: document.getElementById('google_key'),
            recordBtn: document.getElementById('recordBtn'), timer: document.getElementById('timer'),
            fileUploader: document.getElementById('fileUploader'), status: document.getElementById('status'),
            resultContainer: document.getElementById('result-container'), result: document.getElementById('result'),
            summaryStyle: document.getElementById('summaryStyle'), customPrompt: document.getElementById('customPrompt'),
            historyList: document.getElementById('historyList'), historySection: document.getElementById('historySection'),
            copyBtn: document.getElementById('copyBtn'), shareBtn: document.getElementById('shareBtn'),
            pdfBtn: document.getElementById('pdfBtn'), saveToHistory: document.getElementById('saveToHistory'),
            clearHistory: document.getElementById('clearHistory')
        };
        let mediaRecorder, audioChunks = [], isRecording = false, timerInterval, seconds = 0, currentFileName = '', currentTranscript = '';

        // ========== ì´ˆê¸°í™” ë° ì´ë²¤íŠ¸ ë¦¬ìŠ¤ë„ˆ ==========
        window.addEventListener('DOMContentLoaded', init);

        function init() {
            loadApiKeys();
            loadHistory();
            setupEventListeners();
        }

        function setupEventListeners() {
            elements.openaiKey.addEventListener('input', () => saveApiKey('openaiApiKey', elements.openaiKey.value, document.getElementById('openai_saved')));
            elements.googleKey.addEventListener('input', () => saveApiKey('googleApiKey', elements.googleKey.value, document.getElementById('google_saved')));
            elements.recordBtn.addEventListener('click', handleRecord);
            elements.fileUploader.addEventListener('change', handleFileUpload);
            elements.copyBtn.addEventListener('click', () => copyToClipboard(elements.result.innerText, 'ìš”ì•½'));
            elements.shareBtn.addEventListener('click', shareSummary);
            elements.pdfBtn.addEventListener('click', downloadPdf);
            elements.saveToHistory.addEventListener('click', () => saveToHistory({ summary: elements.result.innerText, transcript: currentTranscript, fileName: currentFileName }));
            elements.clearHistory.addEventListener('click', clearHistory);
        }

        // ========== API í‚¤ ê´€ë¦¬ ==========
        function loadApiKeys() { elements.openaiKey.value = localStorage.getItem('openaiApiKey') || ''; elements.googleKey.value = localStorage.getItem('googleApiKey') || ''; }
        function saveApiKey(keyName, value, indicatorEl) { try { localStorage.setItem(keyName, value); indicatorEl.style.opacity = '1'; setTimeout(() => { indicatorEl.style.opacity = '0'; }, 2000); } catch (e) { alert('ë¸Œë¼ìš°ì € ì €ì¥ ê³µê°„ì´ ë¶€ì¡±í•˜ê±°ë‚˜ ë¹„ê³µê°œ ëª¨ë“œì…ë‹ˆë‹¤.'); } }
        function checkApiKeys() { if (!elements.openaiKey.value || !elements.googleKey.value) { alert('API í‚¤ë¥¼ ë¨¼ì € ì…ë ¥í•´ì£¼ì„¸ìš”!'); return false; } return true; }

        // ========== ë…¹ìŒ ë° íŒŒì¼ ì—…ë¡œë“œ ==========
        async function handleRecord() {
            if (!checkApiKeys()) return;
            if (isRecording) {
                mediaRecorder.stop();
            } else {
                try {
                    const stream = await navigator.mediaDevices.getUserMedia({ audio: true });
                    mediaRecorder = new MediaRecorder(stream, { mimeType: 'audio/webm' });
                    audioChunks = [];
                    mediaRecorder.ondataavailable = e => audioChunks.push(e.data);
                    mediaRecorder.onstop = () => {
                        currentFileName = `recording_${new Date().toISOString()}.webm`;
                        processAudio(new Blob(audioChunks, { type: 'audio/webm' }), currentFileName);
                        stream.getTracks().forEach(track => track.stop());
                    };
                    mediaRecorder.start();
                    elements.recordBtn.classList.add('recording'); isRecording = true; startTimer();
                    updateStatus('ğŸ”´ ë…¹ìŒ ì¤‘ì…ë‹ˆë‹¤...');
                } catch (err) { updateStatus("ë§ˆì´í¬ ì ‘ê·¼ ê¶Œí•œì„ í—ˆìš©í•´ì£¼ì„¸ìš”."); }
            }
        }
        function handleFileUpload(event) {
            if (!checkApiKeys()) { event.target.value = ''; return; }
            const file = event.target.files[0];
            if (file) { currentFileName = file.name; processAudio(file, file.name); }
        }

        // ========== í•µì‹¬ ì˜¤ë””ì˜¤ ì²˜ë¦¬ ë¡œì§ ==========
        async function processAudio(audioBlob, fileName) {
            updateStatus('â³ ì˜¤ë””ì˜¤ íŒŒì¼ ì²˜ë¦¬ ì¤€ë¹„ ì¤‘...', true);
            elements.resultContainer.classList.add('hidden');
            const MAX_SIZE = 25 * 1024 * 1024;

            try {
                if (audioBlob.size > MAX_SIZE) {
                    const proceed = confirm(`íŒŒì¼ í¬ê¸°ê°€ 25MBë¥¼ ì´ˆê³¼í–ˆìŠµë‹ˆë‹¤.(${(audioBlob.size / 1024 / 1024).toFixed(2)}MB)\n\në¸Œë¼ìš°ì €ì—ì„œ íŒŒì¼ì„ ìë™ìœ¼ë¡œ ë¶„í• í•˜ì—¬ ì²˜ë¦¬í•©ë‹ˆë‹¤. ì´ ì‘ì—…ì€ ì‹œê°„ì´ ë§¤ìš° ì˜¤ë˜ ê±¸ë¦´ ìˆ˜ ìˆìŠµë‹ˆë‹¤. ê³„ì†í•˜ì‹œê² ìŠµë‹ˆê¹Œ?`);
                    if (!proceed) { updateStatus('ëŒ€ìš©ëŸ‰ íŒŒì¼ ì²˜ë¦¬ê°€ ì·¨ì†Œë˜ì—ˆìŠµë‹ˆë‹¤.'); elements.fileUploader.value = ''; return; }
                    currentTranscript = await processLargeAudio(audioBlob);
                } else {
                    currentTranscript = await transcribeWithWhisper(audioBlob, fileName);
                }

                if (!currentTranscript || currentTranscript.trim().length === 0) { throw new Error('ìŒì„± ì¸ì‹ ê²°ê³¼ê°€ ì—†ìŠµë‹ˆë‹¤.'); }

                updateStatus('â³ Gemini AIê°€ í…ìŠ¤íŠ¸ë¥¼ ìš”ì•½ ì¤‘...', true);
                const summary = await summarizeWithGemini(currentTranscript);

                elements.result.innerText = summary;
                elements.resultContainer.classList.remove('hidden');
                updateStatus('âœ… ìš”ì•½ì´ ì™„ë£Œë˜ì—ˆìŠµë‹ˆë‹¤!');

            } catch (error) {
                updateStatus(`âŒ ì˜¤ë¥˜: ${error.message}`);
            } finally {
                elements.fileUploader.value = '';
            }
        }
        
        async function processLargeAudio(audioBlob) {
            updateStatus('â³ ëŒ€ìš©ëŸ‰ ì˜¤ë””ì˜¤ ë””ì½”ë”© ì¤‘...', true);
            const audioContext = new (window.AudioContext || window.webkitAudioContext)();
            const audioBuffer = await audioContext.decodeAudioData(await audioBlob.arrayBuffer());
            const MAX_CHUNK_BYTES = 24.5 * 1024 * 1024;
            const duration = audioBuffer.duration;
            const numChannels = audioBuffer.numberOfChannels;
            const sampleRate = audioBuffer.sampleRate;
            const totalBytes = duration * sampleRate * numChannels * 2;
            const numChunks = Math.ceil(totalBytes / MAX_CHUNK_BYTES);
            const chunkDuration = duration / numChunks;
            let combinedTranscript = "";

            for (let i = 0; i < numChunks; i++) {
                updateStatus(`â³ ì˜¤ë””ì˜¤ ì¡°ê° ì²˜ë¦¬ ì¤‘... (${i + 1}/${numChunks})`, true);
                const startOffset = Math.floor(i * chunkDuration * sampleRate);
                const endOffset = Math.floor((i + 1) * chunkDuration * sampleRate);
                const chunkBuffer = audioContext.createBuffer(numChannels, endOffset - startOffset, sampleRate);
                for (let channel = 0; channel < numChannels; channel++) {
                    chunkBuffer.copyToChannel(audioBuffer.getChannelData(channel).slice(startOffset, endOffset), channel);
                }
                const chunkWavBlob = audioBufferToWav(chunkBuffer);
                const chunkTranscript = await transcribeWithWhisper(chunkWavBlob, `chunk_${i}.wav`);
                combinedTranscript += chunkTranscript + " ";
            }
            return combinedTranscript;
        }

        // ========== API í˜¸ì¶œ í•¨ìˆ˜ ==========
        async function transcribeWithWhisper(audioBlob, fileName) {
            updateStatus('â³ Whisper AIê°€ í…ìŠ¤íŠ¸ ë³€í™˜ ì¤‘...', true);
            const formData = new FormData();
            formData.append('file', audioBlob, fileName);
            formData.append('model', 'whisper-1');
            const response = await fetch('https://api.openai.com/v1/audio/transcriptions', { method: 'POST', headers: { 'Authorization': `Bearer ${elements.openaiKey.value}` }, body: formData });
            const data = await response.json();
            if (!response.ok) throw new Error(data.error?.message || 'Whisper API í˜¸ì¶œ ì‹¤íŒ¨');
            return data.text;
        }
        async function summarizeWithGemini(transcript) {
            const stylePrompts = {
                default: `ë‹¤ìŒ íšŒì˜ë¡ í…ìŠ¤íŠ¸ë¥¼ ì•„ë˜ í˜•ì‹ì— ë§ì¶° Markdown ì–‘ì‹ìœ¼ë¡œ ìš”ì•½í•´ ì£¼ì„¸ìš”.\n\n[íšŒì˜ë¡ í…ìŠ¤íŠ¸]\n${transcript}\n\n[ìš”ì•½ í˜•ì‹]\n### ğŸ“Œ í•µì‹¬ ìš”ì•½\n\n### ğŸ“ ìƒì„¸ ë‚´ìš©\n- \n\n### ğŸš€ Action Items\n- `,
                brief: `ë‹¤ìŒ í…ìŠ¤íŠ¸ë¥¼ 3-5ì¤„ì˜ í•µì‹¬ ë‚´ìš©ë§Œìœ¼ë¡œ ê°„ëµí•˜ê²Œ ìš”ì•½í•´ì£¼ì„¸ìš”:\n\n${transcript}`,
                detailed: `ë‹¤ìŒ í…ìŠ¤íŠ¸ë¥¼ ê°€ëŠ¥í•œ ìƒì„¸í•˜ê²Œ ìš”ì•½í•˜ë˜, ì²´ê³„ì ìœ¼ë¡œ ì •ë¦¬í•´ì£¼ì„¸ìš”:\n\n${transcript}`,
                minutes: `ë‹¤ìŒ í…ìŠ¤íŠ¸ë¥¼ ì •ì‹ íšŒì˜ë¡ í˜•ì‹ìœ¼ë¡œ ì‘ì„±í•´ì£¼ì„¸ìš” (ì¼ì‹œ, ì°¸ì„ì, ì•ˆê±´, ë…¼ì˜ë‚´ìš©, ê²°ì •ì‚¬í•­ ë“±):\n\n${transcript}`
            };
            let prompt = stylePrompts[elements.summaryStyle.value] || stylePrompts.default;
            if (elements.customPrompt.value.trim()) { prompt += `\n\nì¶”ê°€ ìš”ì²­ì‚¬í•­: ${elements.customPrompt.value}`; }
            
            const body = { contents: [{ parts: [{ text: prompt }] }] };
            const response = await fetch(`https://generativelanguage.googleapis.com/v1beta/models/gemini-1.5-flash:generateContent?key=${elements.googleKey.value}`, { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify(body) });
            const data = await response.json();
            if (!response.ok) throw new Error(data.error?.message || 'Gemini API í˜¸ì¶œ ì‹¤íŒ¨');
            return data.candidates[0].content.parts[0].text;
        }
        
        // ========== íˆìŠ¤í† ë¦¬ ê´€ë¦¬ ==========
        function saveToHistory(data) { try { const history = JSON.parse(localStorage.getItem('summaryHistory') || '[]'); const newEntry = { id: Date.now(), ...data, date: new Date().toISOString() }; history.unshift(newEntry); localStorage.setItem('summaryHistory', JSON.stringify(history.slice(0, 20))); loadHistory(); } catch (e) { console.error('íˆìŠ¤í† ë¦¬ ì €ì¥ ì‹¤íŒ¨:', e); } }
        function loadHistory() { try { const history = JSON.parse(localStorage.getItem('summaryHistory') || '[]'); if (history.length === 0) { elements.historyList.innerHTML = '<p class="text-gray-500 text-sm">ì €ì¥ëœ ìš”ì•½ì´ ì—†ìŠµë‹ˆë‹¤.</p>'; return; } elements.historyList.innerHTML = history.map(item => { const date = new Date(item.date); const dateStr = `${date.toLocaleDateString('ko-KR')} ${date.toLocaleTimeString('ko-KR', { hour: '2-digit', minute: '2-digit' })}`; return `<div class="history-item p-3 bg-white rounded-lg border cursor-pointer" onclick="loadFromHistory(${item.id})"><div class="flex justify-between items-start"><div class="flex-1"><p class="font-semibold text-sm truncate">${item.fileName}</p><p class="text-xs text-gray-500">${dateStr}</p><p class="text-xs text-gray-600 mt-1 line-clamp-2">${item.summary.substring(0, 100)}...</p></div><button onclick="event.stopPropagation(); deleteFromHistory(${item.id})" class="text-red-500 hover:text-red-700 ml-2">ğŸ—‘ï¸</button></div></div>`; }).join(''); } catch (e) { elements.historyList.innerHTML = '<p class="text-red-500 text-sm">íˆìŠ¤í† ë¦¬ë¥¼ ë¶ˆëŸ¬ì˜¬ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.</p>'; } }
        function loadFromHistory(id) { const history = JSON.parse(localStorage.getItem('summaryHistory') || '[]'); const item = history.find(h => h.id === id); if (item) { elements.result.innerText = item.summary; currentTranscript = item.transcript; currentFileName = item.fileName; elements.resultContainer.classList.remove('hidden'); updateStatus('ğŸ“‹ íˆìŠ¤í† ë¦¬ì—ì„œ ë¶ˆëŸ¬ì™”ìŠµë‹ˆë‹¤.'); } }
        function deleteFromHistory(id) { if (confirm('ì´ í•­ëª©ì„ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?')) { const history = JSON.parse(localStorage.getItem('summaryHistory') || '[]'); const filtered = history.filter(h => h.id !== id); localStorage.setItem('summaryHistory', JSON.stringify(filtered)); loadHistory(); } }
        function clearHistory() { if (confirm('ëª¨ë“  íˆìŠ¤í† ë¦¬ë¥¼ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?')) { localStorage.removeItem('summaryHistory'); loadHistory(); } }

        // ========== ìœ í‹¸ë¦¬í‹° í•¨ìˆ˜ ==========
        function updateStatus(message, showLoader = false) { const loaderHtml = showLoader ? '<div class="loader"></div>' : ''; elements.status.innerHTML = `${loaderHtml}<span>${message}</span>`; }
        function startTimer() { seconds = 0; elements.timer.textContent = "00:00"; timerInterval = setInterval(() => { seconds++; const min = String(Math.floor(seconds / 60)).padStart(2, '0'); const sec = String(seconds % 60).padStart(2, '0'); elements.timer.textContent = `${min}:${sec}`; }, 1000); }
        function stopTimer() { clearInterval(timerInterval); if (isRecording) { elements.recordBtn.classList.remove('recording'); isRecording = false; } elements.timer.textContent = "00:00"; }
        function copyToClipboard(text, type = 'í…ìŠ¤íŠ¸') { navigator.clipboard.writeText(text).then(() => alert(`${type}ê°€ ë³µì‚¬ë˜ì—ˆìŠµë‹ˆë‹¤!`)).catch(() => alert("ë³µì‚¬ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.")); }
        async function shareSummary() { if (navigator.share) { await navigator.share({ title: `AI ìš”ì•½: ${currentFileName}`, text: elements.result.innerText }); } else { alert("ì´ ë¸Œë¼ìš°ì €ì—ì„œëŠ” ê³µìœ í•˜ê¸° ê¸°ëŠ¥ì„ ì§€ì›í•˜ì§€ ì•ŠìŠµë‹ˆë‹¤."); } }
        async function downloadPdf() { updateStatus('â³ PDF ìƒì„± ì¤‘...', true); try { const canvas = await html2canvas(elements.result, { scale: 2, useCORS: true, backgroundColor: '#ffffff' }); const imgData = canvas.toDataURL('image/png'); const pdf = new jsPDF({ orientation: 'portrait', unit: 'mm', format: 'a4' }); const pdfWidth = pdf.internal.pageSize.getWidth(); const margin = 15; const contentWidth = pdfWidth - margin * 2; const imgProps = pdf.getImageProperties(imgData); const imgHeight = (imgProps.height * contentWidth) / imgProps.width; pdf.setFontSize(18); pdf.text("AI íšŒì˜ë¡ ìš”ì•½", pdfWidth / 2, margin, { align: 'center' }); pdf.addImage(imgData, 'PNG', margin, margin + 10, contentWidth, imgHeight); const safeFileName = currentFileName.replace(/[^a-zA-Z0-9]/g, '_').replace(/\.[^/.]+$/, ""); pdf.save(`${safeFileName}_summary.pdf`); updateStatus('âœ… PDFê°€ ë‹¤ìš´ë¡œë“œë˜ì—ˆìŠµë‹ˆë‹¤!'); } catch (error) { updateStatus('âŒ PDF ìƒì„±ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.'); } }
        function audioBufferToWav(aBuffer) { let numOfChan = aBuffer.numberOfChannels, len = aBuffer.length * numOfChan * 2 + 44, buffer = new ArrayBuffer(len), view = new DataView(buffer), channels = [], i, sample, offset = 0, pos = 0; setUint32(0x46464952); setUint32(len - 8); setUint32(0x45564157); setUint32(0x20746d66); setUint32(16); setUint16(1); setUint16(numOfChan); setUint32(aBuffer.sampleRate); setUint32(aBuffer.sampleRate * 2 * numOfChan); setUint16(numOfChan * 2); setUint16(16); setUint32(0x61746164); setUint32(len - pos - 4); for (i = 0; i < aBuffer.numberOfChannels; i++) channels.push(aBuffer.getChannelData(i)); while (pos < len) { for (i = 0; i < numOfChan; i++) { sample = Math.max(-1, Math.min(1, channels[i][offset])); sample = (0.5 + sample < 0 ? sample * 32768 : sample * 32767) | 0; view.setInt16(pos, sample, true); pos += 2; } offset++; } return new Blob([view], { type: "audio/wav" }); function setUint16(data) { view.setUint16(pos, data, true); pos += 2; } function setUint32(data) { view.setUint32(pos, data, true); pos += 4; } }

        // ì „ì—­ í•¨ìˆ˜ (ì¸ë¼ì¸ onclickìš©)
        window.loadFromHistory = loadFromHistory;
        window.deleteFromHistory = deleteFromHistory;
    </script>
</body>
</html>

